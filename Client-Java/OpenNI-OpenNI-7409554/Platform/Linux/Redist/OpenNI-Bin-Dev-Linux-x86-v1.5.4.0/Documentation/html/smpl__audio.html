<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OpenNI 1.5.4: NiAudioSample.cpp - sample program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="main.html">OpenNI Overview</a>&nbsp;&raquo;&nbsp;<a class="el" href="smpls__n__guides.html">Samples and Guides</a>&nbsp;&raquo;&nbsp;<a class="el" href="smpls.html">Sample Programs for the OpenNI API</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="smpl_audio">NiAudioSample.cpp - sample program </a></h1><p><b>Source file:</b> Click the following link to view the source code file:</p>
<ul>
<li>NiAudioSample.cpp</li>
</ul>
<p>This section describes an OpenNI sample program for using the Audio interface.</p>
<p>The documentation describes the sample program's code from the top of the program file(s) to bottom.</p>
<p>This documentation item describes only OpenNI code features. Third party features, e.g., GL code, may be ignored. However, place holders as section headings appear in place of complete functions or large code blocks that are not OpenNI specific or key to understanding the logic of the sample program. These place holders are section headings with minimal text to enable the reader to identify the original program structure when studying the documentation.</p>
<p>Every OpenNI feature is described the first time it appears in this sample program. Further appearances of the same feature are not described again.</p>
<h2><a class="anchor" id="bkrec_macros">
Macro Declarations</a></h2>
<p>At the top of the program is a macro utility declaration, which calls OpenNI methods. It is described below. However, for the sake of conciseness, the rest of this documentation skips calls to this macro.</p>
<p>The CHECK_RC() macro checks whether the most recent OpenNI operation was successful or returned an error result. On error, the <a class="el" href="_xn_status_8h.html#a709a2190465f4a6d7893587e53d66798">xnGetStatusString()</a> method converts the OpenNI error return code to the corresponding error string for printing, and the current function exits. </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">            #define CHECK_RC(rc, what) \</span>
<span class="preprocessor">                if (rc != XN_STATUS_OK)                                     \</span>
<span class="preprocessor">                {                                                           \</span>
<span class="preprocessor">                    printf(&quot;%s failed: %s\n&quot;, what, xnGetStatusString(rc)); \</span>
<span class="preprocessor">                    return rc;                                              \</span>
<span class="preprocessor">                }</span>
</pre></div><h2><a class="anchor" id="rec_syn_sample_xml_path">
Declaration of File Path</a></h2>
<p>In the following definitions, SAMPLE_XML_PATH is for the path to an OpenNI XML script input file for building a production graph. The <em>production graph</em> is a network of <em>production nodes</em> and is the principal OpenNI object model. See <a class="el" href="prod__graph.html">The Production Graph</a> for more about the production graph. </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">            #define SAMPLE_XML_PATH &quot;../../../../Data/SamplesConfig.xml&quot;</span>
</pre></div><h2><a class="anchor" id="aud_glb_dcl_blk_ref">
"Declaration Block" section</a></h2>
<p>The reader may find it convenient to study the global declaration block before continuing to study the code statements. The global declaration block is documented later in this section, corresponding to its position in the program file &ndash; see <a class="el" href="smpl__audio.html#aud_glb_dcl_blk">"Declaration Block" section</a>.</p>
<h2><a class="anchor" id="aud_decl_mode">
enum Mode</a></h2>
<p>The following declaration defines the program mode, whether whether it is recording an OpenNI data generation session or whether it is playing a recording. </p>
<div class="fragment"><pre class="fragment">            <span class="keyword">enum</span> Mode
            {
                MODE_PLAY,
                MODE_RECORD,
            };
</pre></div><p>This declaration is not OpenNI specific.</p>
<h2><a class="anchor" id="aud_printusage">
printUsage() method</a></h2>
<p>This function is not OpenNI specific.</p>
<h2><a class="anchor" id="aud_play">
play() method - Play Audio</a></h2>
<p>This routine gets an array of AudioGenerators, takes the first one, and constantly reads data from it and sends it to be played.</p>
<p>The following code block gets the first AudioGenerator node's wave output mode. It is received in an <a class="el" href="_xn_types_8h.html#ac83eeee44ab1363ff8dfc886c8c4c1d0">xn::XnWaveOutputMode</a>, which comprises: bits per sample, channel, and sample rate. This information is then used for setting up the audio output buffers for collecting the generated play data and for setting up the hardware audio output channel. </p>
<div class="fragment"><pre class="fragment">            <a class="code" href="struct_xn_wave_output_mode.html">XnWaveOutputMode</a> waveMode;
            nRetVal = aGens[0].GetWaveOutputMode(waveMode);
            CHECK_RC(nRetVal, <span class="stringliteral">&quot;Failed getting wave output mode&quot;</span>);
</pre></div><p>The above completes the initialization. The following code is the main program loop.</p>
<p>The application calls an 'Update Data()' method, in this case the node's <a class="el" href="classxn_1_1_generator.html#aaf3162a87a79a05fa655f344c835fa2e">WaitAndUpdateData</a>, to make a new frame available for getting. The application can then get the data (for example, using a metadata GetData() method). </p>
<div class="fragment"><pre class="fragment">            nRetVal = aGens[0].WaitAndUpdateData();
</pre></div><p>Assuming the above call succeeded, the application then gets the size of the audio data that was generated by the AudioGenerator node. </p>
<div class="fragment"><pre class="fragment">            XnUInt32 nBufferSize = aGens[0].GetDataSize();
</pre></div><p>The next OpenNI statements copy the AudioGenerator node's data into a prepared buffer to be sent to the machine sound card. <code>xnOSMemCopy</code> is OpenNI memory copy routine. </p>
<div class="fragment"><pre class="fragment">            <a class="code" href="_xn_o_s_memory_8h.html#ac0ba7022d7d4f6e1859dd7ce02c18589">xnOSMemCopy</a>(pHeader-&gt;lpData, aGens[0].GetAudioBuffer(), nBufferSize);
            pHeader-&gt;dwBufferLength = nBufferSize;
</pre></div><h2><a class="anchor" id="aud_record">
record() method - Record Audio</a></h2>
<p>This method gets a list of audio generators, and records to a separate file the data generated by each generator . The following code block creates files named with the names of the AudioGenerator nodes. </p>
<div class="fragment"><pre class="fragment">            XN_FILE_HANDLE aFiles[nSupportedNodes];
            <span class="keywordflow">for</span> (XnUInt32 i = 0; i &lt; nNodes; ++i)
            {
                XnChar strFileName[XN_FILE_MAX_PATH];
                sprintf(strFileName, <span class="stringliteral">&quot;audio.%s.pcm&quot;</span>, aGens[i].GetName());
                nRetVal = <a class="code" href="_xn_o_s_8h.html#abb52a6771e3911589e247d2a37582dd8">xnOSOpenFile</a>(strFileName, <a class="code" href="_xn_o_s_8h.html#ada81ca1478bc791760a0191155cf57b3">XN_OS_FILE_WRITE</a>, &amp;aFiles[i]);
                CHECK_RC(nRetVal, <span class="stringliteral">&quot;Open file&quot;</span>);
            }
</pre></div><p>The application then calls an <a class="el" href="conc__updating__data.html">'Update Data'</a> method, in this case <a class="el" href="classxn_1_1_context.html#a17fab043d7b6d60728511527a1d5c090" title="Updates all generator nodes in the context to their latest available data, first...">xn::Context.WaitAnyUpdateAll()</a>, to update all generator nodes in the context to the latest available data, first waiting for any of the nodes to have new data available. The first call is used just to flush the node. </p>
<div class="fragment"><pre class="fragment">            context.WaitAnyUpdateAll();
</pre></div><p>The following loop checks which node has new data and writes it to a file. The IsDataNew() method returns whether a node's frame data was updated by the most recent call to the WaitAnyUpdateAll() method. </p>
<div class="fragment"><pre class="fragment">            XN_FILE_HANDLE aFiles[nSupportedNodes];
               ...
               ...
            <span class="keywordflow">for</span> (XnUInt32 i = 0; i &lt; nNodes; ++i)
            {
                <span class="keywordflow">if</span> (aGens[i].IsDataNew())
                {
                    nRetVal = <a class="code" href="_xn_o_s_8h.html#ad4b47cf7442bd78d88b7c01e89347099">xnOSWriteFile</a>(aFiles[i], aGens[i].GetAudioBuffer(), aGens[i].GetDataSize());
                    CHECK_RC(nRetVal, <span class="stringliteral">&quot;Write to file&quot;</span>);
                }
            }
</pre></div><h2><a class="anchor" id="aud_mainprg">
Main Program</a></h2>
<h3><a class="anchor" id="aud_glb_dcl_blk">
"Declaration Block" section</a></h3>
<p>The declaration block at the top of the main program declares a <a class="el" href="classxn_1_1_context.html">xn::Context</a> object, an <a class="el" href="classxn_1_1_enumeration_errors.html">xn::EnumerationErrors</a> object, and an <a class="el" href="classxn_1_1_script_node.html">xn::ScriptNode</a> object. The Context object is a workspace in which the application builds an OpenNI production graph. the <a class="el" href="classxn_1_1_enumeration_errors.html">xn::EnumerationErrors</a> object is for collecting errors from any of the OpenNI functions. Also declared is an OpenNI status flag for collecting return values from method calls. the <a class="el" href="classxn_1_1_script_node.html">xn::ScriptNode</a> object loads an XML script from a file or string, and then runs the XML script to build a production graph.</p>
<div class="fragment"><pre class="fragment">                <a class="code" href="_xn_status_8h.html#a23967099202ddb640cd2044b3808253c">XnStatus</a> nRetVal = <a class="code" href="_xn_status_8h.html#a92729089d8e28e740a3f8b5169c8f695">XN_STATUS_OK</a>;
                Context context;
                EnumerationErrors errors;
                  ...
                ScriptNode scriptNode;
</pre></div><h3><a class="anchor" id="aud_main_code">
Main Code Section</a></h3>
<p>In the following, the InitFromXmlFile() method is a shorthand combination of two other initialization methods &ndash; Init() and then RunXmlScriptFromFile() &ndash; which initializes the context object and then creates a production graph from an XML file. </p>
<div class="fragment"><pre class="fragment">                nRetVal = context.InitFromXmlFile(SAMPLE_XML_PATH, scriptNode);         
</pre></div><p>The following code block tests whether a production graph was created. If not, the reason is reported as a list of one or more errors in the <code>errors</code> object. </p>
<div class="fragment"><pre class="fragment">                <span class="keywordflow">if</span> (nRetVal == XN_STATUS_NO_NODE_PRESENT)
                {
                    XnChar strError[1024];
                    errors.ToString(strError, 1024);
                    printf(<span class="stringliteral">&quot;%s\n&quot;</span>, strError);
                    <span class="keywordflow">return</span> (nRetVal);
                }
</pre></div><p>The following code block searches for <a class="el" href="classxn_1_1_audio_generator.html">xn::AudioGenerator</a> nodes in the production graph. The nodes are returned in the <a class="el" href="classxn_1_1_node_info_list.html">xn::NodeInfoList</a> object. This object is a list <a class="el" href="classxn_1_1_node_info.html">xn::NodeInfo</a> objects, each containing information about a node found in the above EnumerateExistingNodes() call.</p>
<div class="fragment"><pre class="fragment">                NodeInfoList list;
                nRetVal = context.EnumerateExistingNodes(list, <a class="code" href="_xn_types_8h.html#ac773bbb9817dac5ae1be0f380ec18b52a8303fcf880f5c311b1a370c83cae3da3">XN_NODE_TYPE_AUDIO</a>);
                CHECK_RC(nRetVal, <span class="stringliteral">&quot;Enumerate audio nodes&quot;</span>); 
                AudioGenerator gens[nSupportedNodes];
                XnUInt32 nNodes = 0;
</pre></div><p>The following declarations and statements get all the <a class="el" href="classxn_1_1_audio_generator.html">xn::AudioGenerator</a> nodes that were found by the EnumerateExistingNodes() call. The <code>gens</code> array receives all the nodes, and they are counted by the <code>nNodes</code> variable. (Currently, only a single AudioGenerator node is supported for playing at at once.) </p>
<div class="fragment"><pre class="fragment">                AudioGenerator gens[nSupportedNodes];
                XnUInt32 nNodes = 0;
                   ...
                <span class="keywordflow">for</span> (NodeInfoList::Iterator it = list.Begin(); it != list.End(); ++it)
                {
                    NodeInfo info = *it;
                    nRetVal = info.GetInstance(gens[nNodes]);
                    CHECK_RC(nRetVal, <span class="stringliteral">&quot;Get audio node&quot;</span>);
                    nNodes++;
                }
</pre></div> </div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed Jun 13 21:55:36 2012 for OpenNI 1.5.4 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
